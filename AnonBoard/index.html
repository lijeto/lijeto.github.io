<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Social Platform</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        #posts-container { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .post { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .post strong { color: #333; }
        .post small { color: #888; display: block; margin-top: 5px; }
        form { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        input[type="text"], textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Public Message Board (No Accounts!)</h1>
    
    <form id="post-form">
        <h2>Post a Message</h2>
        <input type="text" name="Username" placeholder="Your Nickname (Optional)">
        <textarea name="Message" placeholder="What's on your mind?" required></textarea>
        <button type="submit">Post Anonymously</button>
        <p id="form-status"></p>
    </form>
    
    <hr>

    <h2>Recent Posts</h2>
    <div id="posts-container">
        <p>Loading posts...</p>
    </div>

    <script>
        // 🚨 REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL 🚨
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyP5jpp1bxmYJOMvzj0KL8fcyG7sD63QK3Fo87JEaxqitcZbW6-aV-8I59dW5sHfXh/exec'; 

        // 🚨 REPLACE THIS WITH YOUR GOOGLE SHEET "PUBLISH TO THE WEB" CSV/TSV URL 🚨
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNl2vARyFcleNzK6Er2xfQeKhW9fp2YFDTpkUp72VPwkHFRQTgW0_Vblyl7UIRtWnWdIvoVQ7Z0Q_6/pubhtml'; 

        const form = document.getElementById('post-form');
        const statusMessage = document.getElementById('form-status');
        const postsContainer = document.getElementById('posts-container');
        
        // ===================================
        // 1. HANDLE FORM SUBMISSION (Writing Data)
        // ===================================
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusMessage.textContent = 'Submitting post...';
            
            const formData = new FormData(form);
            
            try {
                // Send the form data to the Google Apps Script endpoint
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData // The script expects FormData
                });

                const data = await response.json();

                if (data.result === 'success') {
                    statusMessage.textContent = '✅ Post submitted successfully! Refresh the page to see it.';
                    form.reset();
                } else {
                    statusMessage.textContent = '❌ Error submitting post: ' + data.error;
                }
            } catch (error) {
                statusMessage.textContent = '❌ Network or Submission Error: ' + error.message;
            }
        });
        
        // ===================================
        // 2. FETCH AND DISPLAY POSTS (Reading Data)
        // ===================================
        async function fetchAndDisplayPosts() {
            postsContainer.innerHTML = 'Loading posts...';

            try {
                // Fetch the published data (e.g., as a CSV or TSV file)
                const response = await fetch(DATA_URL);
                const csvText = await response.text();

                // Simple parser: Split into rows by newline, then split by comma/tab for columns
                // For this example, we'll assume a simple comma-separated structure (CSV)
                // You might need a more robust CSV/TSV parser for production
                const rows = csvText.trim().split('\n');
                
                // The first row is the header
                const headers = rows[0].split(','); 
                const dataRows = rows.slice(1);
                
                postsContainer.innerHTML = ''; // Clear "Loading..."
                
                // Loop through posts in reverse (newest first)
                for (let i = dataRows.length - 1; i >= 0; i--) {
                    const columns = dataRows[i].split(',');
                    
                    // Map columns to their respective headers (adjust indices if needed)
                    // Assumes: [0]=Timestamp, [1]=Username, [2]=Message
                    const timestamp = columns[0] || 'Unknown Time';
                    const username = columns[1] || 'Anonymous';
                    const message = columns[2] || 'No content';
                    
                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    postElement.innerHTML = `
                        <strong>${username}</strong>
                        <p>${message}</p>
                        <small>Posted: ${new Date(timestamp).toLocaleString()}</small>
                    `;
                    postsContainer.appendChild(postElement);
                }

                if (dataRows.length === 0) {
                     postsContainer.innerHTML = '<p>No posts yet. Be the first!</p>';
                }

            } catch (error) {
                postsContainer.innerHTML = `<p style="color: red;">Error loading posts. Check the DATA_URL and ensure your sheet is published. Error: ${error.message}</p>`;
            }
        }
        
        // Initial load
        fetchAndDisplayPosts();
    </script>
</body>
</html>
