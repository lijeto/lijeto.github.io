<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnonBoard: Serverless Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">AnonBoard ü§´</h1>
            <p class="text-gray-500">Post anything you like. No sign-ups, no accounts, just messages.</p>
        </header>

        <!-- Post Submission Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Write a New Post</h2>
            <form id="post-form">
                <!-- The 'name' attributes MUST match your Google Sheet headers: Username, Message -->
                <input 
                    type="text" 
                    name="Username" 
                    placeholder="Your Nickname (Optional)" 
                    maxlength="50"
                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <textarea 
                    name="Message" 
                    placeholder="What's happening? (Max 280 characters)" 
                    required 
                    maxlength="280"
                    rows="4"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                ></textarea>
                <button 
                    type="submit" 
                    id="submit-button"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md disabled:opacity-50"
                >
                    Publish Post
                </button>
                <p id="form-status" class="mt-3 text-sm text-center font-medium"></p>
            </form>
        </div>
        
        <!-- Posts Display Area -->
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Latest Posts</h2>
        <div id="posts-container" class="space-y-4">
            <p class="text-center text-gray-500" id="initial-loading">Loading posts...</p>
        </div>
    </div>

    <script>
        // =========================================================================
        // üö® CONFIGURATION: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL URLs üö®
        // =========================================================================
        
        // 1. Google Apps Script Web App URL (for SUBMITTING posts via POST request)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytDTSxGc6aZiR-M4qGyfiO2fJYfW-a74ptad_xI8-QFV_FfsJXKnr9ydpCmG50btaS/exec'; 

        // 2. Google Sheet "Publish to the web" CSV URL (for READING posts via GET request)
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQM-MSZOh_sQeV4-OK9a7UFqEBJ4mKAqOsL58EvACx8BsaNQsL3kTRgd82djIwmR4sUyq0dGZo9ymk2/pub?output=csv'; 
        
        // 3. NEW: Automatic refresh interval (10 seconds)
        const REFRESH_INTERVAL_MS = 10000;
        
        // =========================================================================

        const form = document.getElementById('post-form');
        const submitButton = document.getElementById('submit-button');
        const statusMessage = document.getElementById('form-status');
        const postsContainer = document.getElementById('posts-container');
        
        // --- NEW SANITIZATION FUNCTION ---
        function sanitizeInput(str) {
            if (!str) return '';
            // Replaces HTML special characters with their entity equivalents
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }
        // ---------------------------------
        
        // --- Utility Function to Parse CSV ---
        function parseCSV(csvText) {
            const rows = csvText.trim().split('\n');
            if (rows.length === 0) return [];

            // Simple parser: uses the first row as headers, assumes comma delimiter
            const headers = rows[0].split(','); 
            const dataRows = rows.slice(1);
            const posts = [];

            dataRows.forEach(row => {
                // Use a simple split, which works fine for clean text data
                const columns = row.split(','); 
                
                if (columns.length >= headers.length) {
                    const post = {};
                    headers.forEach((header, index) => {
                        // Trim whitespace and assign to object key
                        post[header.trim()] = columns[index].trim(); 
                    });
                    
                    // --- CHECK: ENSURE THE MESSAGE IS NOT EMPTY ---
                    if (post.Message && post.Message.length > 0) {
                        posts.push(post);
                    }
                }
            });
            // Return posts in reverse order (newest first)
            return posts.reverse();
        }


        // ===================================
        // 1. FETCH AND DISPLAY POSTS (READING)
        // ===================================
        async function fetchAndDisplayPosts() {
            // Check if the posts container is currently empty before clearing, to avoid visual flicker if no changes are made
            const wasEmpty = postsContainer.innerHTML === '';
            if (!wasEmpty) {
                // Optionally show a small loading indicator here instead of clearing the whole thing
                // For simplicity, we'll clear it for now to ensure a fresh display
            }
            postsContainer.innerHTML = ''; // Clear existing posts
            
            try {
                // Use the cache-busting parameter to ensure fresh data
                const cacheBusterUrl = DATA_URL + '&r=' + Date.now();
                const response = await fetch(cacheBusterUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const posts = parseCSV(csvText);

                if (posts.length === 0) {
                     postsContainer.innerHTML = '<p class="text-center text-gray-500 p-4 border rounded-lg">No posts yet. Be the first to share your message!</p>';
                     return;
                }

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                    
                    const username = post.Username || 'Anonymous';
                    let timestamp = 'Just now';
                    
                    if (post.Timestamp) {
                        // Standardize the date string for reliable parsing
                        const dateString = post.Timestamp.replace(' ', 'T') + 'Z';
                        const date = new Date(dateString);

                        if (!isNaN(date)) {
                           // Show only the date
                           timestamp = date.toLocaleDateString();
                        } else {
                           // Fallback if parsing failed
                           timestamp = post.Timestamp; 
                        }
                    }

                    postElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                            <strong class="font-bold text-blue-600">${username}</strong>
                            <span class="text-xs text-gray-400">${timestamp}</span>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">${post.Message || '---'}</p>
                    `;
                    postsContainer.appendChild(postElement);
                });

            } catch (error) {
                postsContainer.innerHTML = `
                    <p class="text-red-500 p-4 border border-red-200 bg-red-50 rounded-lg">
                        ‚ö†Ô∏è Error loading posts. Please verify your DATA_URL. Error: ${error.message}
                    </p>
                `;
                console.error("Error loading posts:", error);
            }
        }
        
        // ===================================
        // 2. HANDLE FORM SUBMISSION (WRITING)
        // ===================================
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            statusMessage.className = 'mt-3 text-sm text-center text-blue-600 font-medium';
            statusMessage.textContent = 'Submitting post... Please wait a moment.';
            
            // --- Sanitize data before creating the FormData object ---
            const sanitizedFormData = new FormData();
            
            // 1. Get raw inputs
            const rawUsername = form.querySelector('[name="Username"]').value;
            const rawMessage = form.querySelector('[name="Message"]').value;
            
            // 2. Sanitize and append
            sanitizedFormData.append('Username', sanitizeInput(rawUsername));
            sanitizedFormData.append('Message', sanitizeInput(rawMessage));
            // -------------------------------------------------------------
            
            try {
                // Send the sanitized form data to the Google Apps Script endpoint (the SCRIPT_URL)
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: sanitizedFormData // Use the sanitized data here
                });

                const data = await response.json();

                if (data.result === 'success') {
                    statusMessage.className = 'mt-3 text-sm text-center text-green-600 font-medium';
                    // We inform the user we are waiting for the published sheet to update
                    statusMessage.textContent = '‚úÖ Post published! Waiting for Google Sheets update...'; 
                    form.reset();
                    
                    // Call fetch after a 3 second delay to give the sheet time to update
                    setTimeout(fetchAndDisplayPosts, 3000); 

                } else {
                    statusMessage.className = 'mt-3 text-sm text-center text-red-600 font-medium';
                    statusMessage.textContent = '‚ùå Submission Error: ' + (data.error || 'Check console for details.');
                }
            } catch (error) {
                statusMessage.className = 'mt-3 text-sm text-center text-red-600 font-medium';
                statusMessage.textContent = '‚ùå Network Error. Is the SCRIPT_URL correct?';
                console.error("Submission fetch failed:", error);
            } finally {
                submitButton.disabled = false;
            }
        });
        
        // Initial call to load posts when the page loads
        document.addEventListener('DOMContentLoaded', fetchAndDisplayPosts);

        // --- NEW: Set up the automatic refresh every 10 seconds ---
        setInterval(fetchAndDisplayPosts, REFRESH_INTERVAL_MS);
    </script>
</body>
</html>
